language:
  - python
python:
  # Warn: since most of the below commands are executing in a docker environment this version may
  # not realistically reflect the python version. Currently, the docker image system python is
  # 3.5 and the virtualenv we source is 3.8.
  - '3.8'
sudo: required
services:
  - docker

env:
  DATA_API_VERSION: "latest"

before_install:
    # Fix intermittent "resource temporarily unavailable" and "write" errors failing the Travis builds.
    # See: https://github.com/travis-ci/travis-ci/issues/8920
    - python -c "import fcntl; fcntl.fcntl(1, fcntl.F_SETFL, 0)"

    # Start up the relevant services
    - docker-compose -f .travis/docker-compose-travis.yml up -d
    - docker exec analytics_api bash -c "
      source /edx/app/analytics_api/venvs/analytics_api/bin/activate &&
      pip install setuptools==49.6.0 &&
      make -C /edx/app/analytics_api/analytics_api travis"
    # HACK: https://github.com/nodejs/docker-node/issues/1199
    - rm package-lock.json

install:
    - pip install -r requirements/travis.txt

script:
    - docker exec -t -e TRAVIS=1 insights_testing bash -c "
      cd /edx/app/insights/edx_analytics_dashboard/ &&
      source /edx/app/insights/venvs/insights/bin/activate &&
      PATH=\$PATH:/edx/app/insights/nodeenvs/insights/bin:/snap/bin &&
      export TOXENV=django32 &&
      pip install -r requirements/travis.txt &&
      make $TARGETS "

matrix:
  include:
    - env:
        TESTNAME=quality-and-js
        TARGETS="requirements.js quality validate_js"
      after_success:
        - codecov --disable pycov
    # a11y has been removed from this list while we investigate failures. MST-1051
    - env:
        TESTNAME=a11y
        TARGETS="requirements.a11y migrate requirements.js static accept"
    - env:
        TESTNAME=test-i18n
        TARGETS="validate_translations generate_fake_translations"
    - env:
        TESTNAME=test-python
        TARGETS="requirements.js static test_python"
      after_success:
        - docker exec insights_testing /edx/app/insights/edx_analytics_dashboard/.travis/run_coverage.sh
        - codecov --disable pycov

after_failure:
    # Print the list of running containers to rule out a killed container as a cause of failure
    - docker ps
